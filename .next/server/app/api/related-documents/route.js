"use strict";(()=>{var e={};e.id=699,e.ids=[699],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},6005:e=>{e.exports=require("node:crypto")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},48378:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var r={};o.r(r),o.d(r,{GET:()=>p});var n=o(72876),s=o(82525),a=o(50567),c=o(99560),i=o(53281),l=o(71017),u=o.n(l),d=o(57147);async function p(e){try{let t;let{searchParams:o}=new URL(e.url),r=o.get("topic");if(!r)return c.NextResponse.json({error:"Topic parameter is required"},{status:400});try{t=await (0,i.Z2)()}catch(r){let e=u().resolve(process.cwd(),"docs/db.json"),o=await d.promises.readFile(e,"utf8");t=JSON.parse(o).documents||[]}let n=t.filter(e=>{let t=(e.topic||"").toLowerCase(),o=(e.category||"").toLowerCase(),n=r.toLowerCase();return t.includes(n)||o.includes(n)}).slice(0,6).map(e=>({title:e.title||"Untitled",topic:e.topic||"Unknown Topic",date:e.date||"Unknown Date",outcome:e.outcome||"No outcome specified",category:e.category||"Uncategorized"}));return c.NextResponse.json({documents:n,total:n.length})}catch(e){return console.error("Error in related-documents route:",e),c.NextResponse.json({error:"Failed to fetch related documents"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/related-documents/route",pathname:"/api/related-documents",filename:"route",bundlePath:"app/api/related-documents/route"},resolvedPagePath:"/Users/harshitduggal/Downloads/thunder-search-1/src/app/api/related-documents/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:m}=g,w="/api/related-documents/route";function x(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},53281:(e,t,o)=>{o.d(t,{PK:()=>N,UY:()=>v,Z2:()=>x});var r=o(74715);o(31085);var n=o(99560),s=o(12995),a=o(61480),c=o(58889),i=o(1430),l=o(70186),u=o(84744),d=o(71017),p=o.n(d);let g=new s.Pinecone({apiKey:process.env.PINECONE_API_KEY});async function f(e){await g.createIndex({name:e,dimension:1024,spec:{serverless:{cloud:"aws",region:"us-east-1"}},waitUntilReady:!0,suppressConflicts:!0})}async function h(e){try{let t=g.index(e),o=await t.describeIndexStats();return!!o.totalRecordCount&&o.totalRecordCount>0}catch(e){return console.error("Error checking Pinecone index:",e),!1}}var m=o(57147),w=o(49221);let x=(0,r.j)("95fda906eca465ef69cced24fa6b8dd70689ef09",y);async function y(){try{let e=p().resolve(process.cwd(),"docs/db.json"),t=await m.promises.readFile(e,"utf8");return JSON.parse(t).documents||[]}catch(e){return console.warn("Could not read metadata from db.json:",e),[]}}let b=e=>{let t={...e};return t.pdf&&(t.pdf.pageCount&&(t.totalPages=t.pdf.pageCount),delete t.pdf),t.loc&&delete t.loc,t},C=async(e,t,o=50)=>{for(let r=0;r<t.length;r+=o){let n=t.slice(r,r+o);console.log(`Upserting batch ${r+1} of ${n.length} vectors...`),await e.upsert(n)}},v=(0,r.j)("d4a6a78ae96fc0eafbfa33875210fe5e1244ef2b",P);async function P(e){let t=process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:`http://localhost:${process.env.PORT}`,o=await fetch(`${t}/api/ingest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({targetIndex:e})});if(!o.ok)throw Error(`API request failed with status ${o.status}`)}let E=e=>{if(!e||"string"!=typeof e)return!1;let t=e.trim();return t.length>0&&t.length<8192},R=()=>new i.s9({chunkSize:2e5,chunkOverlap:4e5,separators:["\n\n","\n"," ",""],lengthFunction:e=>e.length}),j=async(e,t)=>{let o=R(),r=await o.splitDocuments([e]);return r.map((e,o)=>({...e,metadata:{...b(t),id:(0,u.Z)(),chunkIndex:o,totalChunks:r.length,previousChunk:o>0?r[o-1].pageContent:null,nextChunk:o<r.length-1?r[o+1].pageContent:null,contentLength:e.pageContent.length,summary:e.pageContent.substring(0,1e3),keywords:Object.entries(e.pageContent.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(e=>e.length>3).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{})).sort(([,e],[,t])=>t-e).slice(0,20).map(([e])=>e),documentContext:{before:o>0?r[o-1].pageContent:null,after:o<r.length-1?r[o+1].pageContent:null}}}))},N=(0,r.j)("0eb8acfd6359e0a169f2544f558a540be2775fc8",k);async function k(e){try{if(console.log(`Running bootstrapping procedure against Pinecone index: ${e}`),await f(e),await h(e))return console.log("Pinecone index already exists and has vectors in it - returning early"),n.NextResponse.json({success:!0},{status:200});console.log("Loading documents and metadata...");let t=p().resolve(process.cwd(),"docs/"),o=new a.I(t,{".pdf":e=>new c.u(e)}),r=await o.load();if(0===r.length)return console.warn("No PDF documents found in docs directory"),n.NextResponse.json({error:"No documents found"},{status:400});let i=await x(),u=[];for(let e of r){let t=i.find(t=>t.filename===p().basename(e.metadata.source));if(t&&E(e.pageContent)){let o=await j(e,{...e.metadata,...t,pageContent:e.pageContent});u.push(...o)}}console.log(`Processed ${u.length} document chunks`);for(let t=0;t<u.length;t+=5){let o=u.slice(t,t+5);console.log(`Processing batch ${Math.floor(t/5)+1} of ${Math.ceil(u.length/5)}`);try{let t=new l.O({apiKey:process.env.VOYAGE_API_KEY,inputType:"document",modelName:"voyage-law-2"}),r=o.map(e=>e.pageContent);console.log(`Generating embeddings for ${r.length} chunks`);let n=await t.embedDocuments(r);if(!n||n.length!==r.length){console.error("Invalid embeddings response",{expected:r.length,received:n?.length});continue}let a=o.map((e,t)=>({id:e.metadata.id,values:n[t],metadata:e.metadata})),c=new s.Pinecone({apiKey:process.env.PINECONE_API_KEY}).Index(e);await C(c,a,2),await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`Error processing batch ${Math.floor(t/5)+1}:`,{error:e instanceof Error?e.message:"Unknown error",batchSize:o.length});continue}}return console.log("Bootstrap procedure completed successfully."),n.NextResponse.json({success:!0},{status:200})}catch(e){if(console.error("Error during bootstrap procedure:",{message:e.message,cause:e.cause?.message,stack:e.stack}),"UND_ERR_CONNECT_TIMEOUT"===e.code)return n.NextResponse.json({error:"Operation timed out - please try again"},{status:504});return n.NextResponse.json({error:"Bootstrap procedure failed"},{status:500})}}(0,w.h)([x,v,N]),(0,r.j)("77d47cce49b249b42ffdf0c881bc6797f86e1a10",x),(0,r.j)("94587c0bbcc65b3739e073084aa51f10200e1371",v),(0,r.j)("5bfddce852fb04819f701a5fe290fc60a8399f37",N)}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[253,881,277],()=>o(48378));module.exports=r})();
"use strict";(()=>{var e={};e.id=12,e.ids=[12],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},6005:e=>{e.exports=require("node:crypto")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},24440:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>m,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var o={};n.r(o),n.d(o,{POST:()=>u,maxDuration:()=>l});var r=n(72876),s=n(82525),a=n(50567),c=n(99560),i=n(53281);let l=300;async function u(){return await (0,i.UY)(process.env.PINECONE_INDEX),c.NextResponse.json({success:!0},{status:200})}let p=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/bootstrap/route",pathname:"/api/bootstrap",filename:"route",bundlePath:"app/api/bootstrap/route"},resolvedPagePath:"/Users/harshitduggal/Downloads/thunder-search-1/src/app/api/bootstrap/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:g,serverHooks:f}=p,h="/api/bootstrap/route";function m(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},53281:(e,t,n)=>{n.d(t,{PK:()=>j,UY:()=>v,Z2:()=>b});var o=n(74715);n(31085);var r=n(99560),s=n(12995),a=n(61480),c=n(58889),i=n(1430),l=n(70186),u=n(84744),p=n(71017),d=n.n(p);let g=new s.Pinecone({apiKey:process.env.PINECONE_API_KEY});async function f(e){await g.createIndex({name:e,dimension:1024,spec:{serverless:{cloud:"aws",region:"us-east-1"}},waitUntilReady:!0,suppressConflicts:!0})}async function h(e){try{let t=g.index(e),n=await t.describeIndexStats();return!!n.totalRecordCount&&n.totalRecordCount>0}catch(e){return console.error("Error checking Pinecone index:",e),!1}}var m=n(57147),x=n(49221);let b=(0,o.j)("95fda906eca465ef69cced24fa6b8dd70689ef09",w);async function w(){try{let e=d().resolve(process.cwd(),"docs/db.json"),t=await m.promises.readFile(e,"utf8");return JSON.parse(t).documents||[]}catch(e){return console.warn("Could not read metadata from db.json:",e),[]}}let y=e=>{let t={...e};return t.pdf&&(t.pdf.pageCount&&(t.totalPages=t.pdf.pageCount),delete t.pdf),t.loc&&delete t.loc,t},C=async(e,t,n=50)=>{for(let o=0;o<t.length;o+=n){let r=t.slice(o,o+n);console.log(`Upserting batch ${o+1} of ${r.length} vectors...`),await e.upsert(r)}},v=(0,o.j)("d4a6a78ae96fc0eafbfa33875210fe5e1244ef2b",P);async function P(e){let t=process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:`http://localhost:${process.env.PORT}`,n=await fetch(`${t}/api/ingest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({targetIndex:e})});if(!n.ok)throw Error(`API request failed with status ${n.status}`)}let E=e=>{if(!e||"string"!=typeof e)return!1;let t=e.trim();return t.length>0&&t.length<8192},N=()=>new i.s9({chunkSize:2e5,chunkOverlap:4e5,separators:["\n\n","\n"," ",""],lengthFunction:e=>e.length}),R=async(e,t)=>{let n=N(),o=await n.splitDocuments([e]);return o.map((e,n)=>({...e,metadata:{...y(t),id:(0,u.Z)(),chunkIndex:n,totalChunks:o.length,previousChunk:n>0?o[n-1].pageContent:null,nextChunk:n<o.length-1?o[n+1].pageContent:null,contentLength:e.pageContent.length,summary:e.pageContent.substring(0,1e3),keywords:Object.entries(e.pageContent.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(e=>e.length>3).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{})).sort(([,e],[,t])=>t-e).slice(0,20).map(([e])=>e),documentContext:{before:n>0?o[n-1].pageContent:null,after:n<o.length-1?o[n+1].pageContent:null}}}))},j=(0,o.j)("0eb8acfd6359e0a169f2544f558a540be2775fc8",k);async function k(e){try{if(console.log(`Running bootstrapping procedure against Pinecone index: ${e}`),await f(e),await h(e))return console.log("Pinecone index already exists and has vectors in it - returning early"),r.NextResponse.json({success:!0},{status:200});console.log("Loading documents and metadata...");let t=d().resolve(process.cwd(),"docs/"),n=new a.I(t,{".pdf":e=>new c.u(e)}),o=await n.load();if(0===o.length)return console.warn("No PDF documents found in docs directory"),r.NextResponse.json({error:"No documents found"},{status:400});let i=await b(),u=[];for(let e of o){let t=i.find(t=>t.filename===d().basename(e.metadata.source));if(t&&E(e.pageContent)){let n=await R(e,{...e.metadata,...t,pageContent:e.pageContent});u.push(...n)}}console.log(`Processed ${u.length} document chunks`);for(let t=0;t<u.length;t+=5){let n=u.slice(t,t+5);console.log(`Processing batch ${Math.floor(t/5)+1} of ${Math.ceil(u.length/5)}`);try{let t=new l.O({apiKey:process.env.VOYAGE_API_KEY,inputType:"document",modelName:"voyage-law-2"}),o=n.map(e=>e.pageContent);console.log(`Generating embeddings for ${o.length} chunks`);let r=await t.embedDocuments(o);if(!r||r.length!==o.length){console.error("Invalid embeddings response",{expected:o.length,received:r?.length});continue}let a=n.map((e,t)=>({id:e.metadata.id,values:r[t],metadata:e.metadata})),c=new s.Pinecone({apiKey:process.env.PINECONE_API_KEY}).Index(e);await C(c,a,2),await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`Error processing batch ${Math.floor(t/5)+1}:`,{error:e instanceof Error?e.message:"Unknown error",batchSize:n.length});continue}}return console.log("Bootstrap procedure completed successfully."),r.NextResponse.json({success:!0},{status:200})}catch(e){if(console.error("Error during bootstrap procedure:",{message:e.message,cause:e.cause?.message,stack:e.stack}),"UND_ERR_CONNECT_TIMEOUT"===e.code)return r.NextResponse.json({error:"Operation timed out - please try again"},{status:504});return r.NextResponse.json({error:"Bootstrap procedure failed"},{status:500})}}(0,x.h)([b,v,j]),(0,o.j)("77d47cce49b249b42ffdf0c881bc6797f86e1a10",b),(0,o.j)("94587c0bbcc65b3739e073084aa51f10200e1371",v),(0,o.j)("5bfddce852fb04819f701a5fe290fc60a8399f37",j)}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[253,881,277],()=>n(24440));module.exports=o})();